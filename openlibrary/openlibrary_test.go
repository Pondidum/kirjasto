package openlibrary

import (
	"iter"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestBookCreation(t *testing.T) {

	rows := [][]string{
		{`{"type": {"key": "/type/edition"}, "title": "Heroes Gone Rogue", "authors": [{"key": "/authors/OL9400519A"}], "publish_date": "May 25, 2019", "source_records": ["amazon:1097444031", "bwb:9781097444038"], "number_of_pages": 428, "publishers": ["Independently Published", "Independently published"], "isbn_10": ["1097444031"], "isbn_13": ["9781097444038"], "physical_format": "paperback", "notes": {"type": "/type/text", "value": "Source title: Heroes Gone Rogue (Mage for Hire)"}, "covers": [11856567], "works": [{"key": "/works/OL24940134W"}], "key": "/books/OL33151637M", "latest_revision": 2, "revision": 2, "created": {"type": "/type/datetime", "value": "2021-08-30T01:31:11.298001"}, "last_modified": {"type": "/type/datetime", "value": "2022-11-23T23:41:08.217765"}} `, `[{"type":{"key":"/type/author"},"name":"Jason Kenyon","key":"/authors/OL9400519A","source_records":["amazon:1097444031"],"latest_revision":1,"revision":1,"created":{"type":"/type/datetime","value":"2021-08-30T01:31:11.298001"},"last_modified":{"type":"/type/datetime","value":"2021-08-30T01:31:11.298001"}}]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL8173481A"}], "isbn_13": ["9781519158864"], "languages": [{"key": "/languages/eng"}], "number_of_pages": 468, "publish_date": "2015", "publishers": ["CreateSpace Independent Publishing Platform"], "source_records": ["bwb:9781519158864"], "title": "Heroes of Rogue Valley", "weight": "0.595", "works": [{"key": "/works/OL41431936W"}], "key": "/books/OL56269845M", "latest_revision": 1, "revision": 1, "created": {"type": "/type/datetime", "value": "2024-10-02T10:17:11.671289"}, "last_modified": {"type": "/type/datetime", "value": "2024-10-02T10:17:11.671289"}} `, `[{"name":"Ann Roth","created":{"type":"/type/datetime","value":"2020-08-17T14:00:26.715694"},"last_modified":{"type":"/type/datetime","value":"2020-08-17T14:00:26.715694"},"latest_revision":1,"key":"/authors/OL8173481A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"publishers": ["Bloomsbury Childrens an imprint of Bloomsbury Publishing PLC"], "identifiers": {}, "weight": "145 grams", "series": ["yes"], "physical_format": "paperback", "last_modified": {"type": "/type/datetime", "value": "2020-04-07T20:57:15.472517"}, "latest_revision": 2, "key": "/books/OL27935326M", "publish_places": ["england"], "pagination": "400p", "classifications": {}, "contributors": [{"role": "Illustrator", "name": "Erica Salcedo"}], "title": "Kid Normal and the Rogue Heroes", "number_of_pages": 400, "created": {"type": "/type/datetime", "value": "2020-04-07T20:39:56.884030"}, "publish_date": "2017", "copyright_date": "no", "works": [{"key": "/works/OL20189709W"}], "type": {"key": "/type/edition"}, "physical_dimensions": "19.8 x 12.9 x 3 centimeters", "revision": 2} `, `[]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL1218850A"}, {"key": "/authors/OL49921A"}, {"key": "/authors/OL7889674A"}], "isbn_13": ["9781547603336"], "languages": [{"key": "/languages/eng"}], "pagination": "400", "publish_date": "2020", "publishers": ["Bloomsbury Publishing USA"], "source_records": ["bwb:9781547603336"], "title": "Kid Normal and the Rogue Heroes", "weight": "0.455", "full_title": "Kid Normal and the Rogue Heroes", "works": [{"key": "/works/OL21336925W"}], "key": "/books/OL36830853M", "latest_revision": 1, "revision": 1, "created": {"type": "/type/datetime", "value": "2022-01-28T09:49:47.398782"}, "last_modified": {"type": "/type/datetime", "value": "2022-01-28T09:49:47.398782"}} `, `[{"name":"Greg James","personal_name":"Greg James","last_modified":{"type":"/type/datetime","value":"2008-08-18T22:38:55.898644"},"key":"/authors/OL1218850A","type":{"key":"/type/author"},"revision":2},{"name":"Chris Smith","personal_name":"Chris Smith","last_modified":{"type":"/type/datetime","value":"2008-09-12T14:54:45.921535"},"key":"/authors/OL49921A","type":{"key":"/type/author"},"revision":2},{"name":"Erica Salcedo","created":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"last_modified":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"latest_revision":1,"key":"/authors/OL7889674A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"publishers": ["Bloomsbury Publishing Plc"], "source_records": ["bwb:9781547600984", "promise:bwb_daily_pallets_2022-03-17"], "title": "Kid Normal and the Rogue Heroes", "number_of_pages": 416, "isbn_13": ["9781547600984"], "languages": [{"key": "/languages/eng"}], "full_title": "Kid Normal and the Rogue Heroes", "lc_classifications": [""], "publish_date": "2019", "key": "/books/OL28899457M", "authors": [{"key": "/authors/OL1218850A"}, {"key": "/authors/OL49921A"}, {"key": "/authors/OL7889674A"}], "works": [{"key": "/works/OL21336925W"}], "type": {"key": "/type/edition"}, "local_id": ["urn:bwbsku:P7-EMK-278"], "latest_revision": 2, "revision": 2, "created": {"type": "/type/datetime", "value": "2020-08-17T15:32:26.905375"}, "last_modified": {"type": "/type/datetime", "value": "2022-12-07T17:36:58.001486"}} `, `[{"name":"Greg James","personal_name":"Greg James","last_modified":{"type":"/type/datetime","value":"2008-08-18T22:38:55.898644"},"key":"/authors/OL1218850A","type":{"key":"/type/author"},"revision":2},{"name":"Chris Smith","personal_name":"Chris Smith","last_modified":{"type":"/type/datetime","value":"2008-09-12T14:54:45.921535"},"key":"/authors/OL49921A","type":{"key":"/type/author"},"revision":2},{"name":"Erica Salcedo","created":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"last_modified":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"latest_revision":1,"key":"/authors/OL7889674A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"publishers": ["BLOOMSBURY CHILDRENS BOOKS"], "source_records": ["amazon:1408884550", "bwb:9781408884553", "promise:bwb_daily_pallets_2020-07-30"], "title": "Kid Normal and the Rogue Heroes", "identifiers": {"amazon": ["1408884550"]}, "isbn_13": ["9781408884553"], "covers": [8838610], "physical_format": "paperback", "isbn_10": ["1408884550"], "key": "/books/OL27375397M", "authors": [{"key": "/authors/OL7650982A"}], "works": [{"key": "/works/OL20189709W"}], "type": {"key": "/type/edition"}, "local_id": ["urn:bwbsku:KN-518-360"], "latest_revision": 3, "revision": 3, "created": {"type": "/type/datetime", "value": "2019-10-07T18:40:33.784001"}, "last_modified": {"type": "/type/datetime", "value": "2022-12-10T02:52:10.890012"}} `, `[{"name":"Greg James and Chris Smith","created":{"type":"/type/datetime","value":"2019-10-07T18:40:33.784001"},"last_modified":{"type":"/type/datetime","value":"2019-10-07T18:40:33.784001"},"latest_revision":1,"key":"/authors/OL7650982A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL10394876A"}], "isbn_13": ["9798822525290"], "languages": [{"key": "/languages/eng"}], "publish_date": "2022", "publishers": ["IRB MEDIA"], "source_records": ["bwb:9798822525290"], "subjects": ["World history"], "title": "Summary of Ben Macintyre's Rogue Heroes", "works": [{"key": "/works/OL28126067W"}], "key": "/books/OL38498383M", "latest_revision": 1, "revision": 1, "created": {"type": "/type/datetime", "value": "2022-06-19T14:22:55.796633"}, "last_modified": {"type": "/type/datetime", "value": "2022-06-19T14:22:55.796633"}} `, `[{"name":"Irb Media","type":{"key":"/type/author"},"key":"/authors/OL10394876A","source_records":["bwb:9781669381891","bwb:9781638155683","bwb:9781638157199","bwb:9781638157878","bwb:9781638158301","bwb:9781669345008"],"alternate_names":["I. R. B. Media","Irb` + "`" + ` Media","I. R. B. Media Media","I. R. B> Media","IRB Media"],"latest_revision":4,"revision":4,"created":{"type":"/type/datetime","value":"2022-05-26T11:39:55.615275"},"last_modified":{"type":"/type/datetime","value":"2024-05-27T23:08:32.617977"}}]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL1218850A"}, {"key": "/authors/OL49921A"}, {"key": "/authors/OL7889674A"}], "isbn_13": ["9781408884546"], "languages": [{"key": "/languages/eng"}], "number_of_pages": 416, "publish_date": "2018", "publishers": ["Bloomsbury Publishing Plc"], "source_records": ["bwb:9781408884546"], "subjects": ["Children's fiction", "Magic, fiction", "Cats, fiction"], "title": "Kid Normal and the Rogue Heroes", "subtitle": "Kid Normal 2", "full_title": "Kid Normal and the Rogue Heroes Kid Normal 2", "works": [{"key": "/works/OL21336925W"}], "key": "/books/OL34549309M", "latest_revision": 1, "revision": 1, "created": {"type": "/type/datetime", "value": "2021-10-05T21:19:25.273981"}, "last_modified": {"type": "/type/datetime", "value": "2021-10-05T21:19:25.273981"}} `, `[{"name":"Greg James","personal_name":"Greg James","last_modified":{"type":"/type/datetime","value":"2008-08-18T22:38:55.898644"},"key":"/authors/OL1218850A","type":{"key":"/type/author"},"revision":2},{"name":"Chris Smith","personal_name":"Chris Smith","last_modified":{"type":"/type/datetime","value":"2008-09-12T14:54:45.921535"},"key":"/authors/OL49921A","type":{"key":"/type/author"},"revision":2},{"name":"Erica Salcedo","created":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"last_modified":{"type":"/type/datetime","value":"2020-05-14T16:50:54.371321"},"latest_revision":1,"key":"/authors/OL7889674A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"publishers": ["CreateSpace Independent Publishing Platform"], "source_records": ["amazon:1977623646", "bwb:9781977623645"], "title": "Rogue Mage: Age Of Magic - A Kurtherian Gambit Series (Path of Heroes) (Volume 1)", "number_of_pages": 298, "covers": [8565250], "isbn_13": ["9781977623645"], "isbn_10": ["1977623646"], "publish_date": "Aug 10, 2017", "key": "/books/OL26868985M", "authors": [{"key": "/authors/OL7113919A"}, {"key": "/authors/OL7476396A"}], "works": [{"key": "/works/OL19649213W"}], "type": {"key": "/type/edition"}, "latest_revision": 2, "revision": 2, "created": {"type": "/type/datetime", "value": "2019-04-27T23:45:49.056800"}, "last_modified": {"type": "/type/datetime", "value": "2024-10-04T17:55:57.631077"}} `, `[{"name":"Brandon Barr","personal_name":"Brandon Barr","created":{"type":"/type/datetime","value":"2012-04-25T07:29:00.035621"},"last_modified":{"type":"/type/datetime","value":"2012-04-25T07:29:00.035621"},"latest_revision":1,"key":"/authors/OL7113919A","type":{"key":"/type/author"},"revision":1},{"name":"Michael Anderle","created":{"type":"/type/datetime","value":"2019-03-12T09:29:18.507412"},"last_modified":{"type":"/type/datetime","value":"2019-03-12T09:29:18.507412"},"latest_revision":1,"key":"/authors/OL7476396A","type":{"key":"/type/author"},"revision":1}]`},
		{`{"publishers": ["Random House Audio"], "subtitle": "The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "covers": [9140586], "physical_format": "audio cd", "full_title": "Rogue Heroes The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "key": "/books/OL27704881M", "authors": [{"key": "/authors/OL381435A"}], "source_records": ["amazon:0735288097"], "title": "Rogue Heroes", "notes": {"type": "/type/text", "value": "Source title: Rogue Heroes: The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War"}, "identifiers": {"amazon": ["0735288097"]}, "isbn_13": ["9780735288096"], "isbn_10": ["0735288097"], "publish_date": "Oct 04, 2016", "works": [{"key": "/works/OL20036147W"}], "type": {"key": "/type/edition"}, "latest_revision": 3, "revision": 3, "created": {"type": "/type/datetime", "value": "2019-11-16T09:53:26.472893"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"subtitle": "the history of the SAS, Britain's secret special forces unit that sabotaged the Nazis and changed the nature of war", "local_id": ["urn:sfpl:31223119552322", "urn:sfpl:31223119552637", "urn:sfpl:31223119552553", "urn:sfpl:31223119552496", "urn:sfpl:31223119552561", "urn:sfpl:31223119552488", "urn:sfpl:31223119552538", "urn:sfpl:31223119552454", "urn:sfpl:31223119552504", "urn:sfpl:31223119552611", "urn:sfpl:31223119552520", "urn:sfpl:31223119552462", "urn:sfpl:31223119552421", "urn:sfpl:31223119552546", "urn:sfpl:31223119552512", "urn:bwbsku:168-BAA-855"], "subject_times": ["20th century"], "lc_classifications": ["D760.S59 M33 2016"], "key": "/books/OL27216187M", "authors": [{"key": "/authors/OL381435A"}], "subjects": ["Special forces (Military science)", "Commando operations", "Great Britain", "World War, 1939-1945", "Great Britain. Army. Special Air Service", "Regimental histories", "History"], "edition_name": "First edition.", "pagination": "xvi, 380 pages, 32 unnumbered pages of plates", "source_records": ["marc:marc_openlibraries_sanfranciscopubliclibrary/sfpl_chq_2018_12_24_run05.mrc:352969244:4874", "amazon:110190416X", "promise:bwb_daily_pallets_2020-04-02", "marc:marc_columbia/Columbia-extract-20221130-025.mrc:105893014:3374"], "title": "Rogue heroes", "dewey_decimal_class": ["940.54/1241"], "notes": {"type": "/type/text", "value": "Includes bibliographical references (pages 363-364) and index."}, "number_of_pages": 380, "isbn_13": ["9781101904169"], "languages": [{"key": "/languages/eng"}], "subject_places": ["Great Britain"], "isbn_10": ["110190416X"], "publish_date": "2016", "publish_country": "nyu", "copyright_date": "2016", "by_statement": "Ben MacIntyre", "oclc_numbers": ["934676482"], "works": [{"key": "/works/OL20036147W"}], "type": {"key": "/type/edition"}, "identifiers": {"amazon": ["B01AES52F0"]}, "latest_revision": 4, "revision": 4, "created": {"type": "/type/datetime", "value": "2019-07-19T16:10:43.043661"}, "last_modified": {"type": "/type/datetime", "value": "2022-12-19T20:13:31.544700"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"type": {"key": "/type/edition"}, "title": "Rogue Heroes", "authors": [{"key": "/authors/OL381435A"}], "publish_date": "Aug 29, 2017", "source_records": ["amazon:1101904186", "bwb:9781101904183", "promise:bwb_daily_pallets_2021-05-14"], "number_of_pages": 400, "publishers": ["Crown", "Broadway Books"], "isbn_10": ["1101904186"], "isbn_13": ["9781101904183"], "physical_format": "paperback", "full_title": "Rogue Heroes The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "subtitle": "The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "notes": {"type": "/type/text", "value": "Source title: Rogue Heroes: The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War"}, "covers": [11557120], "works": [{"key": "/works/OL20036147W"}], "key": "/books/OL32938137M", "local_id": ["urn:bwbsku:O7-CIX-237"], "latest_revision": 5, "revision": 5, "created": {"type": "/type/datetime", "value": "2021-08-05T21:41:26.108341"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"type": {"key": "/type/edition"}, "title": "Rogue Heroes", "authors": [{"key": "/authors/OL381435A"}], "publish_date": "May 30, 2017", "source_records": ["amazon:0771060327", "promise:bwb_daily_pallets_2020-07-22"], "number_of_pages": 400, "publishers": ["Signal"], "isbn_10": ["0771060327"], "isbn_13": ["9780771060328"], "physical_format": "paperback", "full_title": "Rogue Heroes The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "subtitle": "The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "notes": {"type": "/type/text", "value": "Source title: Rogue Heroes: The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War"}, "works": [{"key": "/works/OL20036147W"}], "key": "/books/OL40216215M", "local_id": ["urn:bwbsku:P4-AXK-551"], "latest_revision": 4, "revision": 4, "created": {"type": "/type/datetime", "value": "2022-10-26T18:50:13.134847"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL381435A"}], "isbn_10": ["0771060300"], "isbn_13": ["9780771060304"], "local_id": ["urn:bwbsku:P4-AZF-330"], "publish_date": "2016-10-04", "publishers": ["Signal"], "source_records": ["promise:bwb_daily_pallets_2020-11-13"], "title": "Rogue Heroes", "subtitle": "The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "full_title": "Rogue Heroes The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "works": [{"key": "/works/OL20036147W"}], "key": "/books/OL45992919M", "latest_revision": 3, "revision": 3, "created": {"type": "/type/datetime", "value": "2023-01-15T15:04:14.678409"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"subtitle": "the history of the SAS, Britain's secret special forces unit that sabotaged the Nazis and changed the nature of the war", "description": {"type": "/type/text", "value": "Britain's Special Air Service--or SAS--was the brainchild of David Stirling, a young, gadabout aristocrat with a remarkable strategic mind. Where his colleagues looked at a map of World War II's African theater and saw a protracted struggle with Rommel's desert forces, Stirling saw an opportunity: given a small number of elite, well-trained men, he could parachute behind Nazi lines and sabotage their airplanes and supplies. Paired with his constitutional opposite, the disciplined martinet Jock Lewes, Stirling assembled a revolutionary fighting force that would upend not just the balance of the war, but the nature of combat itself. He faced no little resistance from those who found his tactics ungentlemanly or beyond the pale, but in the SAS's remarkable exploits facing the Nazis in the Africa and then on the Continent can be found the seeds of nearly all special forces units that would follow. Bringing his keen eye for psychological detail to a riveting wartime narrative, Ben Macintyre uses his unprecedented access to SAS archives to shine a light inside a legendary unit long shrouded in secrecy. The result is not just a tremendous war story, but a fascinating group portrait of men of whom history and country asked the most.--Publisher description."}, "isbn_10": ["1524703397"], "subject_times": ["20th century"], "full_title": "Rogue heroes the history of the SAS, Britain's secret special forces unit that sabotaged the Nazis and changed the nature of the war", "lc_classifications": ["D760.S64 M33 2016b"], "key": "/books/OL27217545M", "authors": [{"key": "/authors/OL381435A"}], "table_of_contents": [{"level": 0, "title": "WAR IN THE DESERT", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Cowboy Soldier", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "L Detachment", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Recruits", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Into the Desert", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "The Long Range Desert Group", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Devil Country", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "A Party of Ghosts", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Blitz Buggy", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Benghazi Bed-And-Breakfast", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Seven Airfields", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Mass Sabotage At Sidi Haneish", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Desert Doctors", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Quite, Quite Mad", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Alamein", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "WAR IN EUROPE", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Italy", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Bulbasket", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Houndsworth", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "An Eye for an Eye", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Paddy McGinty's for Risk", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Battaglione Alleata", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Into the Reich", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Liberation", "type": {"key": "/type/toc_item"}}, {"level": 0, "title": "Who Dares Survives.", "type": {"key": "/type/toc_item"}}], "subjects": ["Special forces (Military science)", "Commando operations", "Great Britain", "World War, 1939-1945", "Great Britain. Army. Special Air Service", "Regimental histories", "History"], "edition_name": "First large print edition.", "pagination": "xxiv, 565 pages, 32 unnumbered pages of plates", "source_records": ["marc:marc_openlibraries_sanfranciscopubliclibrary/sfpl_chq_2018_12_24_run05.mrc:359911286:4386", "promise:bwb_daily_pallets_2020-04-30"], "title": "Rogue heroes", "dewey_decimal_class": ["940.54/1241"], "notes": {"type": "/type/text", "value": "Includes bibliographical references (pages 525-529) and index."}, "number_of_pages": 565, "isbn_13": ["9781524703394"], "languages": [{"key": "/languages/eng"}], "subject_places": ["Great Britain"], "local_id": ["urn:sfpl:31223119553841", "urn:sfpl:31223119553858", "urn:sfpl:31223119553916", "urn:bwbsku:O6-BWV-522"], "publish_date": "2016", "publish_country": "nyu", "by_statement": "Ben MacIntyre", "oclc_numbers": ["968032955", "936347322"], "works": [{"key": "/works/OL20036147W"}], "type": {"key": "/type/edition"}, "latest_revision": 3, "revision": 3, "created": {"type": "/type/datetime", "value": "2019-07-19T16:39:44.127446"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"type": {"key": "/type/edition"}, "title": "Rogue Heroes : The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "authors": [{"key": "/authors/OL381435A"}], "source_records": ["amazon:1509425780"], "publishers": ["Random House"], "isbn_10": ["1509425780"], "isbn_13": ["9781509425785"], "physical_format": "preloaded digital audio player", "full_title": "Rogue Heroes : The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War : Library Edition", "subtitle": "Library Edition", "notes": {"type": "/type/text", "value": "Source title: Rogue Heroes: The History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War: Library Edition"}, "works": [{"key": "/works/OL20036147W"}], "key": "/books/OL41639456M", "latest_revision": 3, "revision": 3, "created": {"type": "/type/datetime", "value": "2022-11-27T00:37:40.504858"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-21T15:29:57.539585"}} `, `[{"photos":[7437600],"personal_name":"Ben Macintyre","bio":"Benedict Richard Pierce Macintyre is a British author, historian, reviewer and columnist writing for The Times newspaper. His columns range from current affairs to historical controversies. - Wikipedia","name":"Ben Macintyre","remote_ids":{"isni":"0000000114423045","viaf":"39453414","wikidata":"Q2895507"},"key":"/authors/OL381435A","alternate_names":["Ben MacIntyre","Benedict Richard Pierce Macintyre"],"birth_date":"25 December 1963","type":{"key":"/type/author"},"source_records":["amazon:2283024714","amazon:024137572X","bwb:9780593728093"],"latest_revision":10,"revision":10,"created":{"type":"/type/datetime","value":"2008-04-01T03:28:50.625462"},"last_modified":{"type":"/type/datetime","value":"2024-08-27T17:00:34.763297"}}]`},
		{`{"type": {"key": "/type/edition"}, "authors": [{"key": "/authors/OL9102926A"}], "isbn_13": ["9781504044950"], "languages": [{"key": "/languages/eng"}], "pagination": "30", "publish_date": "2017", "publishers": ["Worth Books"], "source_records": ["bwb:9781504044950"], "title": "Summary and Analysis of Rogue Heroes : the History of the SAS, Britain's Secret Special Forces Unit That Sabotaged the Nazis and Changed the Nature of War", "subtitle": "Based on the Book by Ben Macintyre", "works": [{"key": "/works/OL36454518W"}], "key": "/books/OL49261876M", "latest_revision": 1, "revision": 1, "created": {"type": "/type/datetime", "value": "2023-08-17T03:20:24.712722"}, "last_modified": {"type": "/type/datetime", "value": "2023-08-17T03:20:24.712722"}} `, `[{"type":{"key":"/type/author"},"name":"Worth Books","key":"/authors/OL9102926A","source_records":["amazon:150404665X"],"latest_revision":1,"revision":1,"created":{"type":"/type/datetime","value":"2021-02-09T05:46:29.689814"},"last_modified":{"type":"/type/datetime","value":"2021-02-09T05:46:29.689814"}}]`},
	}

	books, err := buildResults(t.Context(), asSequence(rows))
	require.NoError(t, err)

	require.Equal(t, 8, len(books))

	require.Equal(t, 0, books[0].rank)
	require.Equal(t, 1, books[1].rank)

	require.Equal(t, "/books/OL27935326M", books[2].openLibraryKey)
	require.Len(t, books[2].OtherEditions, 1)
	require.Equal(t, "/books/OL27375397M", books[2].OtherEditions[0].openLibraryKey)
}

func asSequence(rows [][]string) iter.Seq[bookResult] {
	return func(yield func(bookResult) bool) {
		for _, v := range rows {
			if !yield(bookResult{editionJson: v[0], authorJson: v[1]}) {
				return
			}
		}
	}
}
